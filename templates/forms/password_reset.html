{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Password Reset - Belco Community Credit Union</title>
    <link rel="stylesheet" href="{% static 'assets/css/slick.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/aos.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/output.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}" />
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicon.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/favicon.png' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
      .logo-small { width: 150px !important; height: auto !important; margin-top: 20px; }
      .illustration { max-height: 200px; width: auto; }
      .spinner-border {
        display: inline-block;
        width: 4rem;
        height: 4rem;
        vertical-align: text-bottom;
        border: 0.25em solid #34D399;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border 0.75s linear infinite;
      }
      @keyframes spinner-border { to { transform: rotate(360deg); } }

      
/* Styling the OK (Confirm) button */
.swal2-confirm {
  background-color: #4CAF50 !important; /* Green */
  color: white !important;
  border: none !important;
  padding: 8px 24px !important;
  border-radius: 4px !important;
}

.swal2-confirm:hover {
  background-color: #45a049 !important;
}

/* Styling the Cancel button */
.swal2-cancel {
  background-color: #f44336 !important; /* Red */
  color: white !important;
  border: none !important;
  padding: 8px 24px !important;
  border-radius: 4px !important;
  margin-right: 10px !important; /* Add spacing between buttons */
}

.swal2-cancel:hover {
  background-color: #d32f2f !important;
}

    </style>
  </head>
  <body class="bg-white dark:bg-darkblack-500">
    <div id="spinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <section class="min-h-screen flex flex-col lg:flex-row">
      <!-- Left Section -->
      <div class="lg:w-1/2 flex flex-col justify-center px-4 xl:pl-8 py-6">
        <div class="max-w-[360px] w-full mx-auto">
          <header class="text-center mb-6">
            <img class="logo-small mx-auto mb-6" src="{% static 'images/logo_white.png' %}" alt="Belco Logo"/>
            <h2 class="text-bgray-900 dark:text-white text-3xl font-semibold font-poppins mb-1">Reset Your Password</h2>
            <p class="font-urbanis text-sm font-medium text-bgray-600 dark:text-bgray-50">
              Enter your email to receive a reset code and update your password
            </p>
          </header>

          <form id="password-reset-form" class="space-y-3">
            {% csrf_token %}

            <!-- Step 1: Email -->
            <div id="email-step">
              <label for="email" class="block text-xs font-medium text-bgray-600 dark:text-bgray-50 mb-1">Email</label>
              <input type="email" id="email" name="email" placeholder="Enter your email" class="text-bgray-800 dark:text-white dark:bg-darkblack-500 dark:border-darkblack-400 border border-bgray-300 h-12 w-full max-w-full focus:border-success-300 focus:ring-0 rounded-lg px-3 placeholder:text-bgray-500 placeholder:text-sm" required>
              <button type="submit" data-action="send_code" class="py-3 flex items-center justify-center text-white font-semibold bg-success-300 hover:bg-success-400 transition-all rounded-lg w-full text-sm mt-2">
                Send Reset Code
              </button>
            </div>

            <!-- Step 2: Reset Password -->
            <div id="reset-step" class="hidden">
              <input type="hidden" id="reset-email" name="email">
              
              <label for="code" class="block text-xs font-medium text-bgray-600 dark:text-bgray-50 mb-1">Reset Code</label>
              <input type="text" id="code" name="code" placeholder="Enter reset code" class="text-bgray-800 dark:text-white dark:bg-darkblack-500 dark:border-darkblack-400 border border-bgray-300 h-12 w-full max-w-full focus:border-success-300 focus:ring-0 rounded-lg px-3 placeholder:text-bgray-500 placeholder:text-sm">

              <label for="new_password" class="block text-xs font-medium text-bgray-600 dark:text-bgray-50 mb-1">New Password</label>
              <input type="password" id="new_password" name="new_password" placeholder="New password" class="text-bgray-800 dark:text-white dark:bg-darkblack-500 dark:border-darkblack-400 border border-bgray-300 h-12 w-full max-w-full focus:border-success-300 focus:ring-0 rounded-lg px-3 placeholder:text-bgray-500 placeholder:text-sm">

              <label for="confirm_password" class="block text-xs font-medium text-bgray-600 dark:text-bgray-50 mb-1">Confirm Password</label>
              <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirm password" class="text-bgray-800 dark:text-white dark:bg-darkblack-500 dark:border-darkblack-400 border border-bgray-300 h-12 w-full max-w-full focus:border-success-300 focus:ring-0 rounded-lg px-3 placeholder:text-bgray-500 placeholder:text-sm">

              <button type="submit" data-action="reset_password" class="py-3 flex items-center justify-center text-white font-semibold bg-success-300 hover:bg-success-400 transition-all rounded-lg w-full text-sm mt-2">
                Reset Password
              </button>
            </div>
          </form>

          <p class="text-center text-bgray-900 dark:text-bgray-50 text-sm font-medium pt-4">
            Remembered your password? <a href="{% url 'login' %}" class="font-semibold underline">Sign In</a>
          </p>
          <p class="text-bgray-600 dark:text-white text-center text-xs mt-4">
            &copy; 2025 Belco Community Credit Union. All Rights Reserved.
          </p>
        </div>
      </div>

      <!-- Right Section -->
      <div class="lg:w-1/2 hidden lg:flex flex-col justify-center items-center bg-[#F6FAFF] dark:bg-darkblack-600 pt-6 relative">
        <ul>
          <li class="absolute top-6 left-6">
            <img src="{% static 'assets/images/shapes/square.svg' %}" alt="" class="w-6 h-6" />
          </li>
          <li class="absolute right-8 top-8">
            <img src="{% static 'assets/images/shapes/vline.svg' %}" alt="" class="w-6 h-6" />
          </li>
        </ul>
        <div class="mb-6">
          <img src="{% static 'assets/images/illustration/signup.svg' %}" alt="" class="illustration" />
        </div>
        <div class="text-center max-w-md">
          <h3 class="text-bgray-900 dark:text-white font-semibold font-poppins text-2xl mb-2">Speedy, Easy and Fast</h3>
          <p class="text-bgray-600 dark:text-darkblack-300 text-xs font-medium">
            Join Belco Community Credit Union to manage your finances with ease, access exclusive member benefits, and enjoy personalized banking services tailored to your needs.
          </p>
        </div>
      </div>

      <!-- Scripts -->
      <script src="{% static 'assets/js/jquery-3.6.0.min.js' %}"></script>
      <script src="{% static 'assets/js/aos.js' %}"></script>
      <script src="{% static 'assets/js/slick.min.js' %}"></script>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      <script src="{% static 'assets/js/main.js' %}"></script>
<script>
  AOS.init();

  function showSpinner(){ 
    document.getElementById('spinner').classList.remove('hidden'); 
  }
  function hideSpinner(){ 
    document.getElementById('spinner').classList.add('hidden'); 
  }

  const emailStep = document.getElementById('email-step');
  const resetStep = document.getElementById('reset-step');
  const codeInput = document.getElementById('code');
  const newPasswordInput = document.getElementById('new_password');
  const confirmPasswordInput = document.getElementById('confirm_password');
document.getElementById('password-reset-form').addEventListener('submit', async function(e){
  e.preventDefault();
  showSpinner();

  const submitter = e.submitter;
  const action = submitter.getAttribute('data-action');
  const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;

  // Use FormData manually to ensure email is included
  let data = new FormData();
  if(action === 'send_code'){
    data.append('email', document.getElementById('email').value);
  } else if(action === 'reset_password'){
    data.append('email', document.getElementById('reset-email').value);
    data.append('code', document.getElementById('code').value);
    data.append('new_password', document.getElementById('new_password').value);
    data.append('confirm_password', document.getElementById('confirm_password').value);
  }
  data.append('action', action);

  try {
    const response = await fetch("{% url 'password_reset' %}", {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': csrfToken
      },
      body: data
    });

    const result = await response.json();
    hideSpinner();

    Swal.fire({
      text: result.message,
      icon: result.success ? 'success' : 'error',
      confirmButtonColor: result.success ? '#34D399' : '#EF4444',
    });

    if(result.success){
      if(action === 'send_code'){
        emailStep.classList.add('hidden');
        resetStep.classList.remove('hidden');
        document.getElementById('reset-email').value = result.email;

        codeInput.required = true;
        newPasswordInput.required = true;
        confirmPasswordInput.required = true;
      } else if(action === 'reset_password'){
        window.location.href = "{% url 'login' %}";
      }
    }

  } catch(error){
    hideSpinner();
    Swal.fire({ text:'Something went wrong. Please try again later.', icon:'error', confirmButtonColor:'#EF4444' });
    console.error('Fetch error:', error);
  }
});

</script>

    </section>
  </body>
</html>
