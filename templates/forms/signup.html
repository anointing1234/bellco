{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Sign Up - Belco Community Credit Union</title>
    <link rel="stylesheet" href="{% static 'assets/css/output.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}" />
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicon.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/favicon.png' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
      .logo-small {
        width: 150px !important;
        height: auto !important;
        max-width: none !important;
        margin-top: 20px;
      }
      .illustration {
        max-height: auto;
        width: auto;
      }
      .spinner-border {
        display: inline-block;
        width: 4rem;
        height: 4rem;
        vertical-align: text-bottom;
        border: 0.25em solid #34D399;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border 0.75s linear infinite;
      }
      @keyframes spinner-border {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body class="bg-white dark:bg-darkblack-500">
    <div id="spinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <section class="min-h-screen flex flex-col lg:flex-row">
      <div class="lg:w-1/2 flex flex-col justify-center px-4 xl:pl-8 py-6">
        <div class="max-w-[360px] w-full mx-auto">
          <header class="text-center mb-6">
            <img class="logo-small mx-auto mb-6" src="{% static 'images/logo_white.png' %}" alt="Belco Community Credit Union Logo" />
            <h3 class="text-bgray-900 dark:text-white text-3xl font-semibold font-poppins mb-1">Sign up for an account</h3>
            <p class="font-urbanis text-sm font-medium text-bgray-600 dark:text-darkblack-300">Send, spend and save smarter with Belco</p>
          </header>

          <form id="signup" onsubmit="registration(event)" class="space-y-3">
            {% csrf_token %}
            <fieldset class="space-y-3">
              <legend class="text-sm font-medium text-bgray-600 dark:text-bgray-50 mb-2">Personal Details</legend>
              <div class="flex flex-col md:flex-row gap-3">
                <div class="flex-1 max-w-[170px]">
                  <label for="first_name" class="block text-xs font-medium text-bgray-600 dark:text-bgray-50 mb-1">First Name</label>
                  <input id="first_name" name="first_name" type="text" placeholder="First Name" required class="text-bgray-800 dark:text-white dark:bg-darkblack-500 dark:border-darkblack-400 border border-bgray-300 h-12 w-full max-w-full focus:border-success-300 focus:ring-0 rounded-lg px-3 placeholder:text-bgray-500 placeholder:text-sm" />
                </div>
                <div class="flex-1 max-w-[170px]">
                  <label for="last_name" class="block text-xs font-medium text-bgray-600 dark:text-bgray-50 mb-1">Last Name</label>
                  <input id="last_name" name="last_name" type="text" placeholder="Last Name" required class="text-bgray-800 dark:text-white dark:bg-darkblack-500 dark:border-darkblack-400 border border-bgray-300 h-12 w-full max-w-full focus:border-success-300 focus:ring-0 rounded-lg px-3 placeholder:text-bgray-500 placeholder:text-sm" />
                </div>
              </div>
              <div>
                <label for="phone_number" class="block text-xs font-medium text-bgray-600 dark:text-bgray-50 mb-1">Phone Number</label>
                <input id="phone_number" name="phone_number" type="tel" placeholder="Phone Number" pattern="\+?[0-9]{10,15}" required class="text-bgray-800 dark:text-white dark:bg-darkblack-500 dark:border-darkblack-400 border border-bgray-300 h-12 w-full max-w-full focus:border-success-300 focus:ring-0 rounded-lg px-3 placeholder:text-bgray-500 placeholder:text-sm" />
              </div>
              <div>
                <label for="email" class="block text-xs font-medium text-bgray-600 dark:text-bgray-50 mb-1">Email</label>
                <input id="email" name="email" type="email" placeholder="Email" required class="text-bgray-800 dark:text-white dark:bg-darkblack-500 dark:border-darkblack-400 border border-bgray-300 h-12 w-full max-w-full focus:border-success-300 focus:ring-0 rounded-lg px-3 placeholder:text-bgray-500 placeholder:text-sm" />
              </div>
              <div>
                <label for="gender" class="block text-xs font-medium text-bgray-600 dark:text-bgray-50 mb-1">Gender</label>
                <select id="gender" name="gender" required class="text-bgray-800 dark:text-white dark:bg-darkblack-500 dark:border-darkblack-400 border border-bgray-300 h-12 w-full max-w-full focus:border-success-300 focus:ring-0 rounded-lg px-3 placeholder:text-bgray-500 text-sm">
                  <option value="" disabled selected>Select Gender</option>
                  <option value="M">Male</option>
                  <option value="F">Female</option>
                  <option value="O">Other</option>
                </select>
              </div>
            </fieldset>
            <div class="relative mt-4">
              <label for="password" class="block text-xs font-medium text-bgray-600 dark:text-bgray-50 mb-1">Password</label>
              <input id="password" name="password" type="password" placeholder="Password" required minlength="8" class="text-bgray-800 dark:text-white dark:bg-darkblack-500 dark:border-darkblack-400 border border-bgray-300 h-12 w-full max-w-full focus:border-success-300 focus:ring-0 rounded-lg px-3 placeholder:text-bgray-500 placeholder:text-sm" />
              <button type="button" class="absolute top-3.5 right-2 toggle-password" aria-label="Toggle password visibility">
                <svg class="eye-icon w-4 h-4 mt-0.5" viewBox="0 0 22 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path class="eye-open" d="M11 3C15 3 18.33 5.33 21 10C18.33 14.67 15 17 11 17C7 17 3.67 14.67 1 10C3.67 5.33 7 3 11 3ZM11 15C14.14 15 17 12.76 18.95 10C17 7.24 14.14 5 11 5C7.86 5 5 7.24 3.05 10C5 12.76 7.86 15 11 15ZM11 7C12.6569 7 14 8.34315 14 10C14 11.6569 12.6569 13 11 13C9.34315 13 8 11.6569 8 10C8 8.34315 9.34315 7 11 7Z" fill="#718096" />
                  <path class="eye-closed hidden" d="M2 1L20 19M9.58 8.58C9.21 8.96 9 9.47 9 10C9 10.53 9.21 11.04 9.58 11.42C9.96 11.79 10.47 12 11 12C11.53 12 12.04 11.79 12.41 11.42M8.36 3.36C9.22 3.12 10.11 3 11 3C15 3 18.33 5.33 21 10C20.22 11.36 19.39 12.52 18.5 13.49M16.36 15.35C14.73 16.45 12.94 17 11 17C7 17 3.67 14.67 1 10C2.37 7.61 3.91 5.83 5.63 4.66" stroke="#718096" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </button>
            </div>
            <div class="relative">
              <label for="confirm_password" class="block text-xs font-medium text-bgray-600 dark:text-bgray-50 mb-1">Confirm Password</label>
              <input id="confirm_password" name="confirm_password" type="password" placeholder="Confirm Password" required minlength="8" class="text-bgray-800 dark:text-white dark:bg-darkblack-500 dark:border-darkblack-400 border border-bgray-300 h-12 w-full max-w-full focus:border-success-300 focus:ring-0 rounded-lg px-3 placeholder:text-bgray-500 placeholder:text-sm" />
              <button type="button" class="absolute top-3.5 right-2 toggle-password" aria-label="Toggle password visibility">
                <svg class="eye-icon w-4 h-4 mt-0.5" viewBox="0 0 22 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path class="eye-open" d="M11 3C15 3 18.33 5.33 21 10C18.33 14.67 15 17 11 17C7 17 3.67 14.67 1 10C3.67 5.33 7 3 11 3ZM11 15C14.14 15 17 12.76 18.95 10C17 7.24 14.14 5 11 5C7.86 5 5 7.24 3.05 10C5 12.76 7.86 15 11 15ZM11 7C12.6569 7 14 8.34315 14 10C14 11.6569 12.6569 13 11 13C9.34315 13 8 11.6569 8 10C8 8.34315 9.34315 7 11 7Z" fill="#718096" />
                  <path class="eye-closed hidden" d="M2 1L20 19M9.58 8.58C9.21 8.96 9 9.47 9 10C9 10.53 9.21 11.04 9.58 11.42C9.96 11.79 10.47 12 11 12C11.53 12 12.04 11.79 12.41 11.42M8.36 3.36C9.22 3.12 10.11 3 11 3C15 3 18.33 5.33 21 10C20.22 11.36 19.39 12.52 18.5 13.49M16.36 15.35C14.73 16.45 12.94 17 11 17C7 17 3.67 14.67 1 10C2.37 7.61 3.91 5.83 5.63 4.66" stroke="#718096" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </button>
            </div>
            <div class="flex items-start gap-x-2 text-xs">
              <input type="checkbox" id="terms" required class="mt-1 w-4 h-4 focus:ring-transparent rounded-md border border-bgray-300 focus:accent-success-300 dark:bg-transparent dark:border-darkblack-400" />
              <label for="terms" class="text-bgray-600 dark:text-bgray-50">
                By creating an account, you agree to our
                <a href="#" class="text-bgray-900 dark:text-white">Privacy Policy</a>
                and
                <a href="#" class="text-bgray-900 dark:text-white">Electronics Communication Policy</a>.
              </label>
            </div>
            <button type="submit" class="py-3 flex items-center justify-center text-white font-semibold bg-success-300 hover:bg-success-400 transition-all rounded-lg w-full text-sm">Sign Up</button>
          </form>

          <p class="text-center text-bgray-900 dark:text-bgray-50 text-sm font-medium pt-4">
            Already have an account?
            <a href="{% url 'login' %}" class="font-semibold underline">Sign In</a>
          </p>
          <p class="text-bgray-600 dark:text-darkblack-300 text-center text-xs mt-4">&copy; 2025 Belco Community Credit Union. All Rights Reserved.</p>
        </div>
      </div>

      <div class="lg:w-1/2 hidden lg:flex flex-col justify-center items-center bg-[#F6FAFF] dark:bg-darkblack-600 pt-6 relative">
        <ul>
          <li class="absolute top-6 left-6">
            <img src="{% static 'assets/images/shapes/square.svg' %}" alt="" class="w-6 h-6" />
          </li>
          <li class="absolute right-8 top-8">
            <img src="{% static 'assets/images/shapes/vline.svg' %}" alt="" class="w-6 h-6" />
          </li>
        </ul>
        <div class="mb-6">
          <img src="{% static 'assets/images/illustration/signup.svg' %}" alt="" class="illustration" />
        </div>
        <div class="text-center max-w-md">
          <h3 class="text-bgray-900 dark:text-white font-semibold font-poppins text-2xl mb-2">Speedy, Easy and Fast</h3>
          <p class="text-bgray-600 dark:text-darkblack-300 text-xs font-medium">
            Join Belco Community Credit Union to manage your finances with ease, access exclusive member benefits, and enjoy personalized banking services tailored to your needs.
          </p>
        </div>
      </div>
    </section>

    <script src="{% static 'assets/js/jquery-3.6.0.min.js' %}"></script>
    <script src="{% static 'assets/js/main.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', () => {
          const input = button.parentElement.querySelector('input');
          const eyeOpen = button.querySelector('.eye-open');
          const eyeClosed = button.querySelector('.eye-closed');
          if (input.type === 'password') {
            input.type = 'text';
            eyeOpen.classList.add('hidden');
            eyeClosed.classList.remove('hidden');
          } else {
            input.type = 'password';
            eyeOpen.classList.remove('hidden');
            eyeClosed.classList.add('hidden');
          }
        });
      });

      function showSpinner() {
        document.getElementById('spinner').classList.remove('hidden');
      }

      function hideSpinner() {
        document.getElementById('spinner').classList.add('hidden');
      }

      function showAlert(message, type, redirectUrl = null) {
        Swal.fire({
          text: message,
          icon: type,
          iconColor: type === 'success' ? '#34D399' : '#EF4444',
          confirmButtonText: 'Okay',
          confirmButtonColor: type === 'success' ? '#34D399' : '#EF4444',
          confirmButtonTextColor: '#FFFFFF',
          background: '#FFFFFF',
          color: type === 'success' ? '#34D399' : '#EF4444',
          timer: 5000,
          timerProgressBar: true,
          customClass: {
            popup: 'custom-swal-popup',
            confirmButton: 'custom-swal-button'
          },
          didOpen: () => {
            const $button = document.querySelector('.swal2-confirm');
            if ($button) {
              console.log('Button background:', window.getComputedStyle($button).backgroundColor);
              console.log('Button text color:', window.getComputedStyle($button).color);
              if (window.getComputedStyle($button).color === 'rgba(0, 0, 0, 0)' || window.getComputedStyle($button).color === 'transparent') {
                $button.style.color = '#FFFFFF'; // Fallback if text color is invisible
              }
            }
          }
        }).then((result) => {
          if (result.isConfirmed && redirectUrl) {
            window.location.href = redirectUrl;
          }
        });
      }

      function registration(event) {
        event.preventDefault();
        showSpinner();

        const form = document.getElementById('signup');
        const formData = new FormData(form);
        const password = formData.get('password');
        const confirmPassword = formData.get('confirm_password');
        const gender = formData.get('gender');

        if (password !== confirmPassword) {
          hideSpinner();
          showAlert('Passwords do not match.', 'error');
          return;
        }
        if (!gender) {
          hideSpinner();
          showAlert('Please select a gender.', 'error');
          return;
        }

        const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch("{% url 'register_view' %}", {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
          }
        })
        .then(async (response) => {
          let data;
          try {
            data = await response.json();
          } catch (error) {
            hideSpinner();
            showAlert('Invalid server response. Please try again.', 'error');
            return;
          }

          hideSpinner();

          if (response.ok && data.success) {
            showAlert(data.message || 'Registration successful!', 'success', data.redirect_url || '{% url "login" %}');
          } else {
            showAlert(data.message || 'Please check your details and try again.', 'error');
          }
        })
        .catch((error) => {
          hideSpinner();
          showAlert('Something went wrong. Please try again later.', 'error');
          console.error('Fetch error:', error);
        });
      }

      // Fallback CSS to ensure button text is visible
      const style = document.createElement('style');
      style.textContent = `
        .custom-swal-popup .swal2-confirm {
          color: #000000ff !important;
        }
        .custom-swal-button:hover {
          background-color: darken(#34D399, 10%) !important; /* Darken on hover for success */
        }
        .custom-swal-button:focus {
          outline: none;
          box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.5); /* Green focus ring for success */
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>